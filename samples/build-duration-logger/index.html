<!DOCTYPE html>
<html>

<head>
    <title>Gradle Enterprise Export API Samples: Build duration logger</title>
</head>

<body>
<script>
    const gradleEnterpriseServer = 'https://gradle.my-company.com'; // replace with your Gradle Enterprise base url
    const buildStreamUrl = `${gradleEnterpriseServer}/build-export/v1/builds/since/now?stream`;
    const buildStream = new EventSource(buildStreamUrl);

    class BuildProcessor {

        constructor(gradleEnterpriseServer, maxConcurrentBuildsToProcess) {
            this.gradleEnterpriseServer = gradleEnterpriseServer;
            this.buildIds = [];
            this.numBuildsInProcess = 0;
            this.maxConcurrentBuildsToProcess = maxConcurrentBuildsToProcess;
        }

        enqueue(buildId) {
            this.buildIds.push(buildId);
            this.processQueuedBuilds();
        }

        processQueuedBuilds() {
            if (this.buildIds.length > 0 && this.numBuildsInProcess < this.maxConcurrentBuildsToProcess) {
                this.processBuild(this.buildIds.shift());
                setTimeout(this.processQueuedBuilds.bind(this), 0);
            }
        }

        buildEventStreamUrl(buildId) {
            return `${this.gradleEnterpriseServer}/build-export/v1/build/${buildId}/events?eventTypes=BuildStarted,BuildFinished`;
        }

        processBuild(buildId) {
            this.numBuildsInProcess++;
            const buildEventStream = new EventSource(this.buildEventStreamUrl(buildId));

            let startTime;

            buildEventStream.addEventListener('BuildEvent', event => {
                const buildEventPayload = JSON.parse(event.data);
                const eventType = buildEventPayload.type.eventType;

                if (eventType == 'BuildStarted') {
                    startTime = buildEventPayload.timestamp;
                } else if (eventType == 'BuildFinished') {
                    const endTime = buildEventPayload.timestamp;

                    console.log(`Build ${buildId} completed in ${endTime - startTime}ms`);
                    this.numBuildsInProcess--;
                }
            });
        }
    };

    const maxConcurrentBuildsToProcess = 6;
    const buildProcessor = new BuildProcessor(gradleEnterpriseServer, maxConcurrentBuildsToProcess);

    buildStream.onopen = event => console.log(`Build stream '${buildStreamUrl}' open`);
    buildStream.onerror = event => console.error('Build stream error', event);
    buildStream.addEventListener('Build', event => {
        const buildPayload = JSON.parse(event.data);

        buildProcessor.enqueue(buildPayload.buildId);
    });
</script>
</body>

</html>
